<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Node Registry - Sirr</title>
  <meta name="description" content="Register and manage your Sirr mail service nodes on the blockchain.">
  <link rel="icon" type="image/svg+xml" href="assets/identity.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --color-primary-1: #8D9194;
      --color-primary-2: #4B4E52;
      --color-primary-3: #1C1C1E;
      --color-accent: #5B8DEF;
      --color-accent-hover: #4A7BD9;
      --color-text: #1C1C1E;
      --color-text-light: #6B7280;
      --color-bg: #FFFFFF;
      --color-bg-alt: #F9FAFB;
      --color-success: #10B981;
      --color-warning: #F59E0B;
      --color-error: #EF4444;
      --gradient-primary: linear-gradient(135deg, var(--color-primary-1) 0%, var(--color-primary-2) 50%, var(--color-primary-3) 100%);
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--color-text);
      line-height: 1.6;
      background: var(--color-bg);
    }

    /* Navigation */
    .nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .nav-logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
      color: var(--color-text);
    }

    .nav-logo img {
      width: 36px;
      height: 36px;
    }

    .nav-logo span {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 2rem;
      list-style: none;
    }

    .nav-links a {
      text-decoration: none;
      color: var(--color-text-light);
      font-weight: 500;
      font-size: 0.95rem;
      transition: color 0.2s;
    }

    .nav-links a:hover {
      color: var(--color-text);
    }

    /* Main Content */
    .main {
      padding: 6rem 2rem 4rem;
      min-height: 100vh;
      background: linear-gradient(180deg, var(--color-bg) 0%, var(--color-bg-alt) 100%);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .page-header {
      text-align: center;
      margin-bottom: 3rem;
    }

    .page-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .page-subtitle {
      font-size: 1.125rem;
      color: var(--color-text-light);
      max-width: 600px;
      margin: 0 auto;
    }

    /* Wallet Connection */
    .wallet-section {
      background: white;
      border-radius: var(--radius-lg);
      padding: 1.5rem 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .wallet-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .wallet-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .wallet-status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--color-error);
    }

    .wallet-status-dot.connected {
      background: var(--color-success);
    }

    .wallet-address {
      font-family: monospace;
      font-size: 0.95rem;
      color: var(--color-text-light);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.95rem;
      text-decoration: none;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--color-bg-alt);
      color: var(--color-text);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .btn-secondary:hover {
      border-color: var(--color-primary-2);
    }

    .btn-danger {
      background: var(--color-error);
      color: white;
    }

    .btn-danger:hover {
      opacity: 0.9;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      background: white;
      padding: 0.5rem;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
    }

    .tab-btn {
      flex: 1;
      padding: 1rem;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--color-text-light);
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      color: var(--color-text);
      background: var(--color-bg-alt);
    }

    .tab-btn.active {
      background: var(--gradient-primary);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Cards */
    .card {
      background: white;
      border-radius: var(--radius-lg);
      padding: 2rem;
      box-shadow: var(--shadow-sm);
      margin-bottom: 1.5rem;
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }

    /* Forms */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--color-text);
    }

    .form-input {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: var(--radius-md);
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--color-accent);
      box-shadow: 0 0 0 3px rgba(91, 141, 239, 0.1);
    }

    .form-input::placeholder {
      color: var(--color-text-light);
    }

    .form-hint {
      font-size: 0.875rem;
      color: var(--color-text-light);
      margin-top: 0.5rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }

    /* Node Table */
    .node-table {
      width: 100%;
      border-collapse: collapse;
    }

    .node-table th,
    .node-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .node-table th {
      font-weight: 600;
      color: var(--color-text-light);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .node-table td {
      font-size: 0.95rem;
    }

    .node-table tr:hover {
      background: var(--color-bg-alt);
    }

    .node-domain {
      font-weight: 600;
      color: var(--color-text);
    }

    .node-server {
      font-family: monospace;
      color: var(--color-text-light);
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-pending {
      background: rgba(245, 158, 11, 0.1);
      color: var(--color-warning);
    }

    .status-approved {
      background: rgba(16, 185, 129, 0.1);
      color: var(--color-success);
    }

    .status-rejected {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-error);
    }

    .status-suspended {
      background: rgba(107, 114, 128, 0.1);
      color: var(--color-text-light);
    }

    .status-offline {
      background: rgba(107, 114, 128, 0.1);
      color: var(--color-text-light);
    }

    .status-revoked {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-error);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--color-text-light);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 0.5rem;
    }

    /* Alert */
    .alert {
      padding: 1rem 1.25rem;
      border-radius: var(--radius-md);
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
    }

    .alert-info {
      background: rgba(91, 141, 239, 0.1);
      color: var(--color-accent);
      border: 1px solid rgba(91, 141, 239, 0.2);
    }

    .alert-success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--color-success);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .alert-error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-error);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .alert-warning {
      background: rgba(245, 158, 11, 0.1);
      color: var(--color-warning);
      border: 1px solid rgba(245, 158, 11, 0.2);
    }

    /* Network Badge */
    .network-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--color-bg-alt);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 500;
    }

    .network-icon {
      width: 20px;
      height: 20px;
    }

    /* Loading */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    .loading-dark {
      border-color: rgba(0, 0, 0, 0.1);
      border-top-color: var(--color-text);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: var(--radius-lg);
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      box-shadow: var(--shadow-sm);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--color-text);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--color-text-light);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .nav-links {
        display: none;
      }

      .wallet-section {
        flex-direction: column;
        text-align: center;
      }

      .wallet-info {
        flex-direction: column;
      }

      .tabs {
        flex-direction: column;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .node-table {
        display: block;
        overflow-x: auto;
      }
    }

    /* Node Actions */
    .node-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* Hidden */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <div class="nav-container">
      <a href="index.html" class="nav-logo">
        <img src="assets/identity.svg" alt="Sirr Logo">
        <span>Sirr</span>
      </a>
      <ul class="nav-links">
        <li><a href="index.html#features">Features</a></li>
        <li><a href="index.html#how-it-works">How It Works</a></li>
        <li><a href="index.html#faq">FAQ</a></li>
        <li><a href="http://docs.mailcoin.org/" target="_blank">Docs</a></li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main">
    <div class="container">
      <!-- Page Header -->
      <div class="page-header">
        <h1 class="page-title">Node Registry</h1>
        <p class="page-subtitle">Register and manage your mail service nodes on the blockchain. Become part of the decentralized Sirr network.</p>
      </div>

      <!-- Wallet Connection -->
      <div class="wallet-section">
        <div class="wallet-info">
          <div class="wallet-status">
            <div class="wallet-status-dot" id="walletStatusDot"></div>
            <span id="walletStatusText">Not Connected</span>
          </div>
          <span class="wallet-address" id="walletAddress"></span>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
          <div class="network-badge" id="networkBadge" style="display: none;">
            <span id="networkName">Unknown Network</span>
          </div>
          <button class="btn btn-primary" id="connectWalletBtn" onclick="connectWallet()">
            Connect Wallet
          </button>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-value" id="statTotalNodes">-</div>
          <div class="stat-label">Total Nodes</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statApprovedNodes">-</div>
          <div class="stat-label">Approved Nodes</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statPendingNodes">-</div>
          <div class="stat-label">Pending Approval</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statMyNodes">-</div>
          <div class="stat-label">My Nodes</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('browse')">Browse Nodes</button>
        <button class="tab-btn" onclick="switchTab('register')">Register Node</button>
        <button class="tab-btn" onclick="switchTab('my-nodes')">My Nodes</button>
      </div>

      <!-- Tab: Browse Nodes -->
      <div class="tab-content active" id="tab-browse">
        <div class="card">
          <h2 class="card-title">Approved Service Nodes</h2>
          <div id="approvedNodesContainer">
            <div class="empty-state">
              <div class="empty-state-icon">...</div>
              <p>Loading nodes...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab: Register Node -->
      <div class="tab-content" id="tab-register">
        <div class="card">
          <h2 class="card-title">Register a New Node</h2>

          <div class="alert alert-info" id="registerWalletAlert">
            Please connect your wallet to register a node.
          </div>

          <form id="registerForm" class="hidden">
            <div class="form-group">
              <label class="form-label" for="nodeDomain">Domain *</label>
              <input type="text" class="form-input" id="nodeDomain" placeholder="e.g., mailcoin.org" required>
              <p class="form-hint">The unique domain for your mail service. This cannot be changed after registration.</p>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="nodeServer">Mail Server *</label>
                <input type="text" class="form-input" id="nodeServer" placeholder="e.g., mx1.mailcoin.org" required>
                <p class="form-hint">The mail server address (MX record).</p>
              </div>

              <div class="form-group">
                <label class="form-label" for="nodeRegion">Region</label>
                <input type="text" class="form-input" id="nodeRegion" placeholder="e.g., US-East, EU-West, Asia">
                <p class="form-hint">Geographic region of your server.</p>
              </div>
            </div>

            <div class="alert alert-warning">
              After registration, your node will be in "Pending" status until approved by the network administrator.
            </div>

            <button type="submit" class="btn btn-primary" id="registerBtn">
              Register Node
            </button>
          </form>
        </div>
      </div>

      <!-- Tab: My Nodes -->
      <div class="tab-content" id="tab-my-nodes">
        <div class="card">
          <h2 class="card-title">My Registered Nodes</h2>

          <div class="alert alert-info" id="myNodesWalletAlert">
            Please connect your wallet to view your nodes.
          </div>

          <div id="myNodesContainer" class="hidden">
            <div class="empty-state">
              <div class="empty-state-icon">...</div>
              <p>Loading your nodes...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Update Node Modal -->
  <div class="modal-overlay" id="updateModal">
    <div class="modal">
      <h3 class="modal-title">Update Node</h3>
      <form id="updateForm">
        <input type="hidden" id="updateNodeId">
        <div class="form-group">
          <label class="form-label" for="updateServer">Mail Server *</label>
          <input type="text" class="form-input" id="updateServer" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="updateRegion">Region</label>
          <input type="text" class="form-input" id="updateRegion">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeUpdateModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="updateBtn">Update</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Revoke Confirmation Modal -->
  <div class="modal-overlay" id="revokeModal">
    <div class="modal">
      <h3 class="modal-title">Revoke Node</h3>
      <p style="color: var(--color-text-light); margin-bottom: 1rem;">
        Are you sure you want to revoke this node? This action cannot be undone.
      </p>
      <input type="hidden" id="revokeNodeId">
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeRevokeModal()">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmRevokeBtn" onclick="confirmRevoke()">Revoke Node</button>
      </div>
    </div>
  </div>

  <script>
    // Contract ABI (simplified for the functions we need)
    const CONTRACT_ABI = [
      "function register(string domain, string server, string region) external returns (bytes32)",
      "function updateNode(bytes32 nodeId, string server, string region) external",
      "function revokeNode(bytes32 nodeId) external",
      "function getNode(bytes32 nodeId) external view returns (tuple(address owner, string domain, string server, string region, uint256 registeredAt, uint8 status))",
      "function getApprovedNodes() external view returns (tuple(address owner, string domain, string server, string region, uint256 registeredAt, uint8 status)[])",
      "function getPendingNodes() external view returns (tuple(address owner, string domain, string server, string region, uint256 registeredAt, uint8 status)[])",
      "function getNodeCount() external view returns (uint256)",
      "function getApprovedNodesCount() external view returns (uint256)",
      "function getAllNodeIds() external view returns (bytes32[])",
      "function domainToNodeId(string domain) external view returns (bytes32)",
      "event NodeRegistered(bytes32 indexed nodeId, address indexed owner, string domain, string server, string region)",
      "event NodeUpdated(bytes32 indexed nodeId, string server, string region)",
      "event NodeRevoked(bytes32 indexed nodeId)"
    ];

    // Contract address - UPDATE THIS with your deployed contract address
    const CONTRACT_ADDRESS = "0x0000000000000000000000000000000000000000"; // TODO: Update with actual contract address

    // Node Status enum mapping
    const NodeStatus = {
      0: 'Pending',
      1: 'Approved',
      2: 'Rejected',
      3: 'Suspended',
      4: 'Offline',
      5: 'Revoked'
    };

    // Global state
    let provider = null;
    let signer = null;
    let contract = null;
    let connectedAddress = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      // Check if wallet is already connected
      if (window.ethereum) {
        provider = new ethers.BrowserProvider(window.ethereum);

        // Listen for account changes
        window.ethereum.on('accountsChanged', handleAccountsChanged);
        window.ethereum.on('chainChanged', () => window.location.reload());

        // Check if already connected
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if (accounts.length > 0) {
          await connectWallet();
        } else {
          loadPublicData();
        }
      } else {
        loadPublicData();
      }
    });

    // Connect wallet
    async function connectWallet() {
      const btn = document.getElementById('connectWalletBtn');

      if (!window.ethereum) {
        alert('Please install MetaMask or another Web3 wallet to use this feature.');
        return;
      }

      try {
        btn.innerHTML = '<span class="loading"></span>';
        btn.disabled = true;

        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        connectedAddress = await signer.getAddress();

        // Initialize contract
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        // Update UI
        updateWalletUI(true);

        // Load data
        await loadAllData();

      } catch (error) {
        console.error('Failed to connect wallet:', error);
        alert('Failed to connect wallet. Please try again.');
      } finally {
        btn.innerHTML = connectedAddress ? 'Disconnect' : 'Connect Wallet';
        btn.disabled = false;
        btn.onclick = connectedAddress ? disconnectWallet : connectWallet;
      }
    }

    // Disconnect wallet
    function disconnectWallet() {
      connectedAddress = null;
      signer = null;
      contract = null;
      updateWalletUI(false);
      loadPublicData();
    }

    // Handle account changes
    function handleAccountsChanged(accounts) {
      if (accounts.length === 0) {
        disconnectWallet();
      } else {
        connectWallet();
      }
    }

    // Update wallet UI
    async function updateWalletUI(connected) {
      const dot = document.getElementById('walletStatusDot');
      const statusText = document.getElementById('walletStatusText');
      const addressEl = document.getElementById('walletAddress');
      const networkBadge = document.getElementById('networkBadge');
      const networkName = document.getElementById('networkName');
      const registerAlert = document.getElementById('registerWalletAlert');
      const registerForm = document.getElementById('registerForm');
      const myNodesAlert = document.getElementById('myNodesWalletAlert');
      const myNodesContainer = document.getElementById('myNodesContainer');

      if (connected && connectedAddress) {
        dot.classList.add('connected');
        statusText.textContent = 'Connected';
        addressEl.textContent = `${connectedAddress.slice(0, 6)}...${connectedAddress.slice(-4)}`;

        // Get network info
        const network = await provider.getNetwork();
        networkBadge.style.display = 'flex';
        networkName.textContent = getNetworkName(network.chainId);

        registerAlert.classList.add('hidden');
        registerForm.classList.remove('hidden');
        myNodesAlert.classList.add('hidden');
        myNodesContainer.classList.remove('hidden');
      } else {
        dot.classList.remove('connected');
        statusText.textContent = 'Not Connected';
        addressEl.textContent = '';
        networkBadge.style.display = 'none';

        registerAlert.classList.remove('hidden');
        registerForm.classList.add('hidden');
        myNodesAlert.classList.remove('hidden');
        myNodesContainer.classList.add('hidden');
      }
    }

    // Get network name from chain ID
    function getNetworkName(chainId) {
      const networks = {
        1n: 'Ethereum Mainnet',
        5n: 'Goerli Testnet',
        11155111n: 'Sepolia Testnet',
        137n: 'Polygon',
        80001n: 'Mumbai Testnet',
        56n: 'BNB Chain',
        97n: 'BNB Testnet',
        42161n: 'Arbitrum One',
        10n: 'Optimism',
        8453n: 'Base'
      };
      return networks[chainId] || `Chain ${chainId}`;
    }

    // Load public data (no wallet needed)
    async function loadPublicData() {
      if (CONTRACT_ADDRESS === "0x0000000000000000000000000000000000000000") {
        document.getElementById('approvedNodesContainer').innerHTML = `
          <div class="alert alert-warning">
            Contract address not configured. Please update the CONTRACT_ADDRESS in the code.
          </div>
        `;
        return;
      }

      try {
        const readProvider = provider || new ethers.JsonRpcProvider();
        const readContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readProvider);

        // Load approved nodes
        await loadApprovedNodes(readContract);

        // Load stats
        await loadStats(readContract);
      } catch (error) {
        console.error('Error loading public data:', error);
      }
    }

    // Load all data (with wallet)
    async function loadAllData() {
      try {
        await loadApprovedNodes(contract);
        await loadStats(contract);
        await loadMyNodes();
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    // Load approved nodes
    async function loadApprovedNodes(contractInstance) {
      const container = document.getElementById('approvedNodesContainer');

      try {
        const nodes = await contractInstance.getApprovedNodes();

        if (nodes.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">&#128274;</div>
              <p class="empty-state-title">No Approved Nodes Yet</p>
              <p>Be the first to register a node!</p>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <table class="node-table">
            <thead>
              <tr>
                <th>Domain</th>
                <th>Server</th>
                <th>Region</th>
                <th>Status</th>
                <th>Registered</th>
              </tr>
            </thead>
            <tbody>
              ${nodes.map(node => `
                <tr>
                  <td class="node-domain">${escapeHtml(node.domain)}</td>
                  <td class="node-server">${escapeHtml(node.server)}</td>
                  <td>${escapeHtml(node.region) || '-'}</td>
                  <td><span class="status-badge status-approved">Approved</span></td>
                  <td>${formatDate(node.registeredAt)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        console.error('Error loading approved nodes:', error);
        container.innerHTML = `
          <div class="alert alert-error">
            Failed to load nodes. Please check your network connection.
          </div>
        `;
      }
    }

    // Load stats
    async function loadStats(contractInstance) {
      try {
        const [totalCount, approvedCount] = await Promise.all([
          contractInstance.getNodeCount(),
          contractInstance.getApprovedNodesCount()
        ]);

        document.getElementById('statTotalNodes').textContent = totalCount.toString();
        document.getElementById('statApprovedNodes').textContent = approvedCount.toString();

        // Calculate pending (total - approved - other statuses)
        try {
          const pendingNodes = await contractInstance.getPendingNodes();
          document.getElementById('statPendingNodes').textContent = pendingNodes.length.toString();
        } catch {
          document.getElementById('statPendingNodes').textContent = '-';
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load my nodes
    async function loadMyNodes() {
      const container = document.getElementById('myNodesContainer');

      if (!connectedAddress || !contract) {
        return;
      }

      try {
        // Get all node IDs and filter by owner
        const allNodeIds = await contract.getAllNodeIds();
        const myNodes = [];

        for (const nodeId of allNodeIds) {
          const node = await contract.getNode(nodeId);
          if (node.owner.toLowerCase() === connectedAddress.toLowerCase()) {
            myNodes.push({ nodeId, ...node });
          }
        }

        document.getElementById('statMyNodes').textContent = myNodes.length.toString();

        if (myNodes.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">&#128203;</div>
              <p class="empty-state-title">No Nodes Registered</p>
              <p>You haven't registered any nodes yet.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <table class="node-table">
            <thead>
              <tr>
                <th>Domain</th>
                <th>Server</th>
                <th>Region</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${myNodes.map(node => `
                <tr>
                  <td class="node-domain">${escapeHtml(node.domain)}</td>
                  <td class="node-server">${escapeHtml(node.server)}</td>
                  <td>${escapeHtml(node.region) || '-'}</td>
                  <td><span class="status-badge status-${NodeStatus[node.status].toLowerCase()}">${NodeStatus[node.status]}</span></td>
                  <td class="node-actions">
                    ${node.status !== 5 ? `
                      <button class="btn btn-secondary btn-sm" onclick="openUpdateModal('${node.nodeId}', '${escapeHtml(node.server)}', '${escapeHtml(node.region)}')">Update</button>
                      <button class="btn btn-danger btn-sm" onclick="openRevokeModal('${node.nodeId}')">Revoke</button>
                    ` : '<span style="color: var(--color-text-light);">Revoked</span>'}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        console.error('Error loading my nodes:', error);
        container.innerHTML = `
          <div class="alert alert-error">
            Failed to load your nodes. Please try again.
          </div>
        `;
      }
    }

    // Switch tabs
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach((btn, index) => {
        const tabs = ['browse', 'register', 'my-nodes'];
        btn.classList.toggle('active', tabs[index] === tabName);
      });

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // Register node form submission
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const btn = document.getElementById('registerBtn');
      const domain = document.getElementById('nodeDomain').value.trim();
      const server = document.getElementById('nodeServer').value.trim();
      const region = document.getElementById('nodeRegion').value.trim();

      if (!domain || !server) {
        alert('Please fill in all required fields.');
        return;
      }

      try {
        btn.innerHTML = '<span class="loading"></span> Registering...';
        btn.disabled = true;

        const tx = await contract.register(domain, server, region);
        await tx.wait();

        alert('Node registered successfully! It will be reviewed by the administrator.');

        // Reset form
        document.getElementById('registerForm').reset();

        // Reload data
        await loadAllData();

        // Switch to my nodes tab
        switchTab('my-nodes');

      } catch (error) {
        console.error('Registration failed:', error);
        alert('Registration failed: ' + (error.reason || error.message));
      } finally {
        btn.innerHTML = 'Register Node';
        btn.disabled = false;
      }
    });

    // Update node modal
    function openUpdateModal(nodeId, server, region) {
      document.getElementById('updateNodeId').value = nodeId;
      document.getElementById('updateServer').value = server;
      document.getElementById('updateRegion').value = region;
      document.getElementById('updateModal').classList.add('active');
    }

    function closeUpdateModal() {
      document.getElementById('updateModal').classList.remove('active');
    }

    document.getElementById('updateForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const btn = document.getElementById('updateBtn');
      const nodeId = document.getElementById('updateNodeId').value;
      const server = document.getElementById('updateServer').value.trim();
      const region = document.getElementById('updateRegion').value.trim();

      try {
        btn.innerHTML = '<span class="loading"></span>';
        btn.disabled = true;

        const tx = await contract.updateNode(nodeId, server, region);
        await tx.wait();

        closeUpdateModal();
        alert('Node updated successfully!');
        await loadMyNodes();

      } catch (error) {
        console.error('Update failed:', error);
        alert('Update failed: ' + (error.reason || error.message));
      } finally {
        btn.innerHTML = 'Update';
        btn.disabled = false;
      }
    });

    // Revoke node modal
    function openRevokeModal(nodeId) {
      document.getElementById('revokeNodeId').value = nodeId;
      document.getElementById('revokeModal').classList.add('active');
    }

    function closeRevokeModal() {
      document.getElementById('revokeModal').classList.remove('active');
    }

    async function confirmRevoke() {
      const btn = document.getElementById('confirmRevokeBtn');
      const nodeId = document.getElementById('revokeNodeId').value;

      try {
        btn.innerHTML = '<span class="loading"></span>';
        btn.disabled = true;

        const tx = await contract.revokeNode(nodeId);
        await tx.wait();

        closeRevokeModal();
        alert('Node revoked successfully.');
        await loadAllData();

      } catch (error) {
        console.error('Revoke failed:', error);
        alert('Revoke failed: ' + (error.reason || error.message));
      } finally {
        btn.innerHTML = 'Revoke Node';
        btn.disabled = false;
      }
    }

    // Close modals on outside click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });

    // Helper functions
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function formatDate(timestamp) {
      const date = new Date(Number(timestamp) * 1000);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }
  </script>
</body>
</html>
